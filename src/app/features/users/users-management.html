<div class="container">
  <h1 class="title">Gestión de Usuarios</h1>
  @if(isAdmin){
  <div class="field">
    <label class="label">Filtrar por Tenant ID:</label>
    <div class="control">
      <div class="select">
        <select [(ngModel)]="selectedTenantId" (change)="applyFilter()">
          <option [ngValue]="null">Todos los Tenants</option>
          <option value="tenant1">Tenant 1</option>
          <option value="tenant2">Tenant 2</option>
        </select>
      </div>
    </div>
  </div>
  <div class="buttons">
    <button class="button is-primary" (click)="filterUsers()">Aplicar Filtro</button>
    <button class="button is-success" (click)="openAddUserModal()">Añadir Nuevo Usuario</button>
  </div>

  }

  @if(isLoading$ | async){
  <div class="notification is-info">
    Cargando usuarios...
  </div>
  }
  @if(usersError$ | async; as error) {
  @if(error && error.trim().length > 0) {
  <div class="notification is-danger">
    <strong>Error:</strong> {{ error }}
  </div>
  }
  }
  <table class="table is-fullwidth is-striped is-hoverable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Nombre Completo</th>
        <th>Roles</th>
        <th>Tenant ID</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of filteredUsers">
        <td>{{ user.id }}</td>
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.firstName }} {{ user.lastName }}</td>
        <td>
          <span class="tag is-light mr-1" *ngFor="let role of user.roles">{{ role }}</span>
        </td>
        <td>{{ user.tenantId }}</td>
        <td>
          <button class="button is-small is-info mr-2" (click)="viewDetails(user)">Ver Detalles</button>


          <button class="button is-small is-warning mr-2" (click)="onEditUser(user)"
            *ngIf="isAdmin || user.tenantId === currentTenantId">Editar</button>
          <button class="button is-small is-danger" (click)="onDeleteUser(user.id)"
            *ngIf="isAdmin || user.tenantId === currentTenantId">Eliminar</button>

        </td>
      </tr>
      <tr *ngIf="filteredUsers.length === 0 && !(isLoading$ | async)">
        <td colspan="7" class="has-text-centered">No hay usuarios para mostrar.</td>
      </tr>
    </tbody>
  </table>

  <div class="modal" [ngClass]="{'is-active': (selectedUser$ | async)}">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Detalles del Usuario</p>
        <button class="delete" aria-label="close" (click)="closeDetails()"></button>
      </header>
      <section class="modal-card-body">
        <div *ngIf="selectedUser$ | async as user">
          <p><strong>ID:</strong> {{ user.id }}</p>
          <p><strong>Username:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Nombre:</strong> {{ user.firstName }} {{ user.lastName }}</p>
          <p><strong>Roles:</strong> <span class="tag is-light mr-1" *ngFor="let role of user.roles">{{ role }}</span>
          </p>
          <p><strong>Tenant ID:</strong> {{ user.tenantId }}</p>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button" (click)="closeDetails()">Cerrar</button>
      </footer>
    </div>
  </div>

  <div class="modal" [ngClass]="{'is-active': isEditModalActive}">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">{{ isEditMode ? 'Editar Usuario' : 'Añadir Nuevo Usuario' }}</p>
        <button class="delete" aria-label="close" (click)="closeEditModal()"></button>
      </header>
      <section class="modal-card-body">
        <form (ngSubmit)="saveUser()">
          <div class="field">
            <label class="label" for="username">Username</label>
            <div class="control">
              <input class="input" type="text" id="username" name="username" [(ngModel)]="currentUserForm.username"
                required>
            </div>
          </div>

          <div class="field">
            <label class="label" for="email">Email</label>
            <div class="control">
              <input class="input" type="email" id="email" name="email" [(ngModel)]="currentUserForm.email" required>
            </div>
          </div>

          <div class="field">
            <label class="label" for="firstName">Nombre</label>
            <div class="control">
              <input class="input" type="text" id="firstName" name="firstName" [(ngModel)]="currentUserForm.firstName"
                required>
            </div>
          </div>

          <div class="field">
            <label class="label" for="lastName">Apellido</label>
            <div class="control">
              <input class="input" type="text" id="lastName" name="lastName" [(ngModel)]="currentUserForm.lastName"
                required>
            </div>
          </div>

          <div class="field">
            <label class="label" for="roles">Roles</label>
            <div class="control">
              <div class="select is-multiple">
                <select id="roles" name="roles" [(ngModel)]="currentUserForm.roles" multiple size="2">
                  <option value="user">user</option>
                  <option value="admin">admin</option>
                </select>
              </div>
              <p class="help">Ctrl/Cmd + click para seleccionar múltiples</p>
            </div>
          </div>

          <div class="field">
            <label class="label" for="tenantId">Tenant ID</label>
            <div class="control">
              <div class="select">
                <select id="tenantId" name="tenantId" [(ngModel)]="currentUserForm.tenantId" required>
                  <option value="tenant1">Tenant 1</option>
                  <option value="tenant2">Tenant 2</option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" (click)="saveUser()">{{ isEditMode ? 'Guardar Cambios' : 'Añadir Usuario'
          }}</button>
        <button class="button" (click)="closeEditModal()">Cancelar</button>
      </footer>
    </div>
  </div>
</div>
